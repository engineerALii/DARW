<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ®Ù…ÙŠÙ† ÙˆØ§Ù„Ø±Ø³Ù… - ØºØ±Ù Ø®Ø§ØµØ©</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://pngimg.com/d/letter_s_PNG29.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, arrayUnion, increment, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD6MRZ7d7J1333erYoBrUGqocJNdGNjB7w",
            authDomain: "neew-aec2b.firebaseapp.com",
            databaseURL: "https://neew-aec2b-default-rtdb.firebaseio.com",
            projectId: "neew-aec2b",
            storageBucket: "neew-aec2b.firebasestorage.app",
            messagingSenderId: "70112873200",
            appId: "1:70112873200:web:b8ef2b3863be6f1bf39035"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-gartic-app-v3-rooms';

        // --- Global State ---
        let currentUser = null;
        let currentRoomCode = null; // New: Store current room code
        let roomData = null;
        let players = [];
        let messages = [];
        let strokes = [];
        let isDrawing = false;
        let currentPoints = [];
        let currentColor = '#000000';
        let currentLineWidth = 5;
        let timeLeft = 0;
        let timerInterval = null;
        let isDrawer = false;
        let heartbeatInterval = null;
        let cleanupInterval = null;
        let unsubscribeRoom = null;
        let unsubscribePlayers = null;
        let unsubscribeMessages = null;

        // --- DOM Elements ---
        const views = {
            login: document.getElementById('login-view'),
            lobby: document.getElementById('lobby-view'),
            game: document.getElementById('game-view')
        };
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');

        // --- Word List ---
        const WORD_LIST = [
            "Ù‚Ø·Ø©", "ÙƒÙ„Ø¨", "Ø³ÙŠØ§Ø±Ø©", "Ø´Ø¬Ø±Ø©", "Ù…Ù†Ø²Ù„", "Ø´Ù…Ø³", "Ù‚Ù…Ø±", "Ù†Ø¬Ù…Ø©", "Ø³Ø­Ø§Ø¨Ø©", "Ù…Ø·Ø±",
            "Ø¨Ø­Ø±", "Ù‚Ø§Ø±Ø¨", "Ø·Ø§Ø¦Ø±Ø©", "Ø¯Ø±Ø§Ø¬Ø©", "ÙƒØ±Ø©", "ØªÙ„ÙØ§Ø²", "Ø­Ø§Ø³ÙˆØ¨", "Ù‡Ø§ØªÙ", "Ø³Ø§Ø¹Ø©", "Ù†Ø¸Ø§Ø±Ø©",
            "ÙƒØ±Ø³ÙŠ", "Ø·Ø§ÙˆÙ„Ø©", "Ø³Ø±ÙŠØ±", "Ù…ØµØ¨Ø§Ø­", "Ø¨Ø§Ø¨", "Ø´Ø¨Ø§Ùƒ", "Ù‚Ù„Ù…", "ÙƒØªØ§Ø¨", "Ø­Ù‚ÙŠØ¨Ø©", "Ø­Ø°Ø§Ø¡",
            "Ù‚Ù…ÙŠØµ", "Ø¨Ù†Ø·Ø§Ù„", "Ù‚Ø¨Ø¹Ø©", "Ø¬ÙˆØ±Ø¨", "Ù…Ù„Ø¹Ù‚Ø©", "Ø´ÙˆÙƒØ©", "Ø³ÙƒÙŠÙ†", "Ø·Ø¨Ù‚", "ÙƒÙˆØ¨", "Ø²Ø¬Ø§Ø¬Ø©",
            "ØªÙØ§Ø­Ø©", "Ù…ÙˆØ²Ø©", "Ø¨Ø±ØªÙ‚Ø§Ù„Ø©", "Ø¹Ù†Ø¨", "Ø¨Ø·ÙŠØ®", "ÙØ±Ø§ÙˆÙ„Ø©", "Ù„ÙŠÙ…ÙˆÙ†", "Ø¬Ø²Ø±Ø©", "Ø®ÙŠØ§Ø±", "Ø·Ù…Ø§Ø·Ù…",
            "Ø¨Ø·Ø§Ø·Ø³", "Ø¨ØµÙ„", "Ø«ÙˆÙ…", "Ø®Ø¨Ø²", "Ø¨ÙŠØ¶", "Ø¬Ø¨Ù†", "Ù„Ø­Ù…", "Ø¯Ø¬Ø§Ø¬", "Ø³Ù…Ùƒ", "Ø¢ÙŠØ³ ÙƒØ±ÙŠÙ…",
            "ÙƒØ¹ÙƒØ©", "Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©", "Ù‚Ù‡ÙˆØ©", "Ø´Ø§ÙŠ", "Ø¹ØµÙŠØ±", "Ù…Ø§Ø¡", "Ø­Ù„ÙŠØ¨", "Ø¹Ø³Ù„", "Ø³ÙƒØ±", "Ù…Ù„Ø­",
            "ÙÙ„ÙÙ„", "Ø²Ù‡Ø±Ø©", "ÙˆØ±Ø¯Ø©", "Ø¹Ø´Ø¨", "Ù†Ø®Ù„Ø©", "ØµØ¨Ø§Ø±", "Ø¬Ø¨Ù„", "ÙˆØ§Ø¯ÙŠ", "Ù†Ù‡Ø±", "Ø¨Ø­ÙŠØ±Ø©",
            "ØµØ­Ø±Ø§Ø¡", "ØºØ§Ø¨Ø©", "Ø­Ø¯ÙŠÙ‚Ø©", "Ù…Ø¯Ø±Ø³Ø©", "Ù…Ø³ØªØ´ÙÙ‰", "Ù…Ø³Ø¬Ø¯", "Ø³ÙˆÙ‚", "Ù…Ø·Ø¹Ù…", "ÙÙ†Ø¯Ù‚", "Ù…Ø·Ø§Ø±",
            "Ù…Ø­Ø·Ø©", "Ø¬Ø³Ø±", "Ù†ÙÙ‚", "Ø·Ø±ÙŠÙ‚", "Ø§Ø´Ø§Ø±Ø© Ù…Ø±ÙˆØ±", "Ø´Ø±Ø·ÙŠ", "Ø·Ø¨ÙŠØ¨", "Ù…Ø¹Ù„Ù…", "Ù…Ù‡Ù†Ø¯Ø³", "Ø·Ø¨Ø§Ø®",
            "Ø®ÙŠØ§Ø·", "Ø­Ù„Ø§Ù‚", "Ù†Ø¬Ø§Ø±", "Ø­Ø¯Ø§Ø¯", "Ù…Ø²Ø§Ø±Ø¹", "ØµÙŠØ§Ø¯", "Ø¬Ù†Ø¯ÙŠ", "Ø·ÙŠØ§Ø±", "Ø³Ø§Ø¦Ù‚", "Ø±Ø¬Ù„ Ø§Ø·ÙØ§Ø¡",
            "Ø§Ø³Ø¯", "Ù†Ù…Ø±", "ÙÙŠÙ„", "Ø²Ø±Ø§ÙØ©", "Ù‚Ø±Ø¯", "Ø¯Ø¨", "Ø°Ø¦Ø¨", "Ø«Ø¹Ù„Ø¨", "Ø§Ø±Ù†Ø¨", "Ø³Ù„Ø­ÙØ§Ø©",
            "ØªÙ…Ø³Ø§Ø­", "Ø«Ø¹Ø¨Ø§Ù†", "Ù†Ø³Ø±", "ØµÙ‚Ø±", "Ø¨ÙˆÙ…Ø©", "Ø¹ØµÙÙˆØ±", "Ø­Ù…Ø§Ù…Ø©", "Ø¨Ø·Ø©", "Ø¯ÙŠÙƒ", "Ø¯Ø¬Ø§Ø¬Ø©",
            "Ø¨Ù‚Ø±Ø©", "Ø®Ø±ÙˆÙ", "Ù…Ø§Ø¹Ø²", "Ø­ØµØ§Ù†", "Ø­Ù…Ø§Ø±", "Ø¬Ù…Ù„", "ØºØ²Ø§Ù„", "ÙƒÙ†ØºØ±", "Ø¨Ø·Ø±ÙŠÙ‚", "Ø¯ÙˆÙ„ÙÙŠÙ†",
            "Ø­ÙˆØª", "Ù‚Ø±Ø´", "Ø§Ø®Ø·Ø¨ÙˆØ·", "Ù‚Ù†Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø±", "Ù†Ø­Ù„Ø©", "Ù†Ù…Ù„Ø©", "ÙØ±Ø§Ø´Ø©", "Ø¹Ù†ÙƒØ¨ÙˆØª", "Ø¹Ù‚Ø±Ø¨", "Ø°Ø¨Ø§Ø¨Ø©",
            "Ø¨Ø¹ÙˆØ¶Ø©", "ØµØ±ØµÙˆØ±", "Ø®Ù†ÙØ³Ø§Ø¡", "Ø¯ÙˆØ¯Ø©", "Ø­Ù„Ø²ÙˆÙ†", "Ø¶ÙØ¯Ø¹", "Ø³Ø­Ù„ÙŠØ©", "Ø¯ÙŠÙ†Ø§ØµÙˆØ±", "ØªÙ†ÙŠÙ†", "ÙˆØ­Ø´",
            "Ø´Ø¨Ø­", "ÙØ¶Ø§Ø¡", "ÙƒÙˆÙƒØ¨", "Ù…Ø¬Ø±Ø©", "ØµØ§Ø±ÙˆØ®", "Ø±Ø§Ø¦Ø¯ ÙØ¶Ø§Ø¡", "Ø·Ø¨Ù‚ Ø·Ø§Ø¦Ø±", "Ø±ÙˆØ¨ÙˆØª", "Ø§Ù„Ø© Ø²Ù…Ù†", "ÙƒÙ†Ø²",
            "Ø®Ø±ÙŠØ·Ø©", "Ø¨ÙˆØµÙ„Ø©", "Ù…Ø¸Ù„Ø©", "Ù…Ù‚Øµ", "Ù…ÙØªØ§Ø­", "Ù‚ÙÙ„", "Ø¬Ø±Ø³", "Ø¹Ù„Ù…", "Ø¨Ø§Ù„ÙˆÙ†", "Ø·Ø§Ø¦Ø±Ø© ÙˆØ±Ù‚ÙŠØ©",
            "Ø§Ø±Ø¬ÙˆØ­Ø©", "Ø²Ø­Ù„ÙˆÙ‚Ø©", "Ù„Ø¹Ø¨Ø©", "Ø¯Ù…ÙŠØ©", "Ø±Ù…Ù„", "Ø«Ù„Ø¬", "Ø±Ø¬Ù„ Ø«Ù„Ø¬", "Ù†Ø§Ø±", "Ø¯Ø®Ø§Ù†", "Ø±Ù…Ø§Ø¯",
            "Ø¨Ø±ÙƒØ§Ù†", "Ø²Ù„Ø²Ø§Ù„", "Ø§Ø¹ØµØ§Ø±", "ÙÙŠØ¶Ø§Ù†", "Ø¬ÙØ§Ù", "Ø®Ø±ÙŠÙ", "Ø´ØªØ§Ø¡", "Ø±Ø¨ÙŠØ¹", "ØµÙŠÙ", "Ø§Ù„ÙˆØ§Ù†",
            "Ø±Ø³Ù…", "ÙØ±Ø´Ø§Ø©", "Ù„ÙˆØ­Ø©", "Ù…ØªØ­Ù", "Ù…Ø³Ø±Ø­", "Ø³ÙŠÙ†Ù…Ø§", "ÙÙŠÙ„Ù…", "Ø§ØºÙ†ÙŠØ©", "Ù…ÙˆØ³ÙŠÙ‚Ù‰", "Ø±Ù‚Øµ"
        ];

        // --- Initialization ---
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loading-screen').classList.add('hidden');
                switchView('login');
            }
        });

        // --- View Management ---
        function switchView(viewName) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            if (viewName === 'game') {
                resizeCanvas();
            }
        }

        // --- Heartbeat & Cleanup Logic ---
        function startHeartbeatSystem(roomCode) {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (cleanupInterval) clearInterval(cleanupInterval);

            // 1. Send Heartbeat (Update my lastActive)
            heartbeatInterval = setInterval(async () => {
                if (!currentUser || !roomCode) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${roomCode}_players`, currentUser.uid), {
                        lastActive: Date.now()
                    });
                } catch (e) { console.error("Heartbeat error", e); }
            }, 5000); // Every 5 seconds

            // 2. Cleanup Inactive Users (Check every 10 seconds)
            cleanupInterval = setInterval(() => {
                const now = Date.now();
                players.forEach(async (p) => {
                    // If player hasn't updated in 60 seconds, delete them
                    if (now - (p.lastActive || 0) > 60000) {
                        console.log(`Removing inactive player: ${p.name}`);
                        try {
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${roomCode}_players`, p.id));
                        } catch (e) { console.error("Cleanup error", e); }
                    }
                });
            }, 10000);
        }

        // --- Firestore Listeners ---
        function setupFirestoreListeners(roomCode) {
            // Unsubscribe previous listeners if any
            if (unsubscribeRoom) unsubscribeRoom();
            if (unsubscribePlayers) unsubscribePlayers();
            if (unsubscribeMessages) unsubscribeMessages();

            // 1. Room Data Listener
            unsubscribeRoom = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode), (snap) => {
                if (snap.exists()) {
                    roomData = snap.data();
                    strokes = roomData.strokes || [];
                    isDrawer = roomData.drawerId === currentUser.uid;
                    
                    updateGameUI();
                    drawCanvas();
                    
                    // Handle Timer
                    if (roomData.roundEndTime) {
                        const now = Date.now();
                        const end = roomData.roundEndTime.toMillis ? roomData.roundEndTime.toMillis() : roomData.roundEndTime;
                        const left = Math.max(0, Math.ceil((end - now) / 1000));
                        timeLeft = left;
                        document.getElementById('timer-display').textContent = timeLeft + 's';
                        
                        if (timeLeft === 0 && roomData.status === 'playing' && isDrawer) {
                            endRound();
                        }
                    }

                    // Auto switch views
                    if ((roomData.status === 'playing' || roomData.status === 'finished') && !views.game.classList.contains('hidden') === false) {
                        if (players.find(p => p.id === currentUser.uid)) { 
                            switchView('game');
                        }
                    }
                    if (roomData.status === 'lobby' && !views.lobby.classList.contains('hidden') === false) {
                         if (players.find(p => p.id === currentUser.uid)) {
                            switchView('lobby');
                         }
                    }
                } else {
                    // Create room if it doesn't exist
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode), {
                        status: 'lobby',
                        currentWord: '',
                        drawerId: null,
                        roundEndTime: null,
                        strokes: [],
                        usedWords: [],
                        createdAt: serverTimestamp()
                    });
                }
            });

            // 2. Players Listener
            unsubscribePlayers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', `room_${roomCode}_players`), (snap) => {
                players = [];
                snap.forEach(d => players.push({ id: d.id, ...d.data() }));
                // Local filter for inactive users to make UI snappy
                // players = players.filter(p => (Date.now() - (p.lastActive || Date.now())) < 65000);
                players.sort((a, b) => b.score - a.score);
                renderPlayers();
            });

            // 3. Messages Listener
            unsubscribeMessages = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', `room_${roomCode}_messages`), (snap) => {
                messages = [];
                snap.forEach(d => messages.push({ id: d.id, ...d.data() }));
                messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                renderMessages();
            });
        }

        // --- Game Logic ---
        window.joinGame = async () => {
            const nameInput = document.getElementById('player-name');
            const roomInput = document.getElementById('room-code');
            const name = nameInput.value.trim();
            const code = roomInput.value.trim();

            if (!name) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…!');
            if (!code) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©!');

            currentRoomCode = code;

            // Update Header with Room Code
            document.getElementById('room-display').innerText = `Ø§Ù„ØºØ±ÙØ©: ${code}`;
            document.getElementById('room-display').classList.remove('hidden');

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${code}_players`, currentUser.uid), {
                name: name,
                score: 0,
                avatar: Math.floor(Math.random() * 5),
                lastActive: Date.now()
            });

            setupFirestoreListeners(code);
            startHeartbeatSystem(code);
            switchView('lobby');
        };

        window.startGame = async () => {
            if (!roomData) return; // Guard clause
            if (players.length < 2) {
                 // alert('Ù†Ø­ØªØ§Ø¬ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ø«Ù†ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!');
                 // Testing mode allowed
            }

            const randomPlayer = players[Math.floor(Math.random() * players.length)];
            
            let availableWords = WORD_LIST.filter(w => !roomData.usedWords?.includes(w));
            if (availableWords.length === 0) {
                availableWords = WORD_LIST;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomCode), { usedWords: [] });
            }
            const newWord = availableWords[Math.floor(Math.random() * availableWords.length)];

            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomCode), {
                status: 'playing',
                drawerId: randomPlayer.id,
                currentWord: newWord,
                roundEndTime: Date.now() + 60000,
                strokes: [],
                usedWords: arrayUnion(newWord)
            });
        };

        async function endRound() {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomCode), {
                status: 'finished',
                roundEndTime: Date.now() + 5000
            });
            setTimeout(async () => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomCode), {
                    status: 'lobby',
                    currentWord: '',
                    drawerId: null
                });
            }, 5000);
        }

        // --- Chat & Guessing ---
        window.sendMessage = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !roomData) return; // Added roomData check

            const isCorrect = roomData.status === 'playing' && !isDrawer && text === roomData.currentWord;

            if (isCorrect) {
                // Score Logic
                const points = 10 + Math.floor(timeLeft / 5);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${currentRoomCode}_players`, currentUser.uid), {
                    score: increment(points)
                });
                if (roomData.drawerId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `room_${currentRoomCode}_players`, roomData.drawerId), {
                        score: increment(5)
                    });
                }
                
                await setDoc(doc(collection(db, 'artifacts', appId, 'public', 'data', `room_${currentRoomCode}_messages`)), {
                    text: `ğŸ‰ ${players.find(p => p.id === currentUser.uid)?.name} Ø®Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©!`,
                    sender: 'System',
                    isSystem: true,
                    timestamp: Date.now()
                });
                
                endRound();
            } else {
                await setDoc(doc(collection(db, 'artifacts', appId, 'public', 'data', `room_${currentRoomCode}_messages`)), {
                    text: text,
                    sender: players.find(p => p.id === currentUser.uid)?.name || 'Unknown',
                    senderId: currentUser.uid,
                    isDrawer: isDrawer,
                    timestamp: Date.now()
                });
            }
            input.value = '';
        };

        // --- Canvas Logic ---
        function resizeCanvas() {
            const container = canvas.parentElement;
            if(container) {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                drawCanvas(); 
            }
        }
        window.addEventListener('resize', resizeCanvas);

        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            strokes.forEach(stroke => {
                drawSmoothStroke(stroke.points, stroke.color, stroke.width);
            });

            if (currentPoints.length > 0) {
                drawSmoothStroke(currentPoints, currentColor, currentLineWidth);
            }
        }

        function drawSmoothStroke(points, color, width) {
            if (points.length < 2) return;
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            const w = canvas.width;
            const h = canvas.height;
            ctx.moveTo(points[0].x * w, points[0].y * h);
            if (points.length === 2) {
                ctx.lineTo(points[1].x * w, points[1].y * h);
                ctx.stroke();
                return;
            }
            for (let i = 1; i < points.length - 2; i++) {
                const xc = (points[i].x * w + points[i + 1].x * w) / 2;
                const yc = (points[i].y * h + points[i + 1].y * h) / 2;
                ctx.quadraticCurveTo(points[i].x * w, points[i].y * h, xc, yc);
            }
            ctx.quadraticCurveTo(
                points[points.length - 2].x * w,
                points[points.length - 2].y * h,
                points[points.length - 1].x * w,
                points[points.length - 1].y * h
            );
            ctx.stroke();
        }

        function getCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) / rect.width,
                y: (clientY - rect.top) / rect.height
            };
        }

        function startDrawing(e) {
            if (!isDrawer) return;
            e.preventDefault();
            isDrawing = true;
            const coords = getCoords(e);
            currentPoints = [coords];
            drawCanvas();
        }

        function moveDrawing(e) {
            if (!isDrawing || !isDrawer) return;
            e.preventDefault();
            const coords = getCoords(e);
            currentPoints.push(coords);
            drawCanvas();
        }

        async function stopDrawing() {
            if (!isDrawing || !isDrawer) return;
            isDrawing = false;
            if (currentPoints.length > 1) {
                const newStroke = { color: currentColor, width: currentLineWidth, points: currentPoints };
                strokes.push(newStroke);
                drawCanvas();
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomCode), {
                    strokes: arrayUnion(newStroke)
                });
            }
            currentPoints = [];
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', moveDrawing);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, {passive: false});
        canvas.addEventListener('touchmove', moveDrawing, {passive: false});
        canvas.addEventListener('touchend', stopDrawing);

        window.clearCanvas = async () => {
            if (!isDrawer) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomCode), { strokes: [] });
        };

        window.setTool = (color, width) => {
            if(color) currentColor = color;
            if(width) currentLineWidth = width;
        };

        // --- Maximize Logic ---
        let isMaximized = false;
        window.toggleMaximize = () => {
            isMaximized = !isMaximized;
            const playersSidebar = document.getElementById('players-sidebar');
            const chatSidebar = document.getElementById('chat-sidebar');
            const maxIcon = document.getElementById('maximize-icon');

            if (isMaximized) {
                playersSidebar.classList.add('hidden');
                chatSidebar.classList.add('hidden');
                maxIcon.setAttribute('data-lucide', 'minimize-2');
            } else {
                playersSidebar.classList.remove('hidden');
                chatSidebar.classList.remove('hidden');
                maxIcon.setAttribute('data-lucide', 'maximize-2');
            }
            lucide.createIcons();
            setTimeout(resizeCanvas, 50);
        };

        // --- UI Rendering ---
        function renderPlayers() {
            const lobbyList = document.getElementById('lobby-players');
            const gameList = document.getElementById('game-players');
            
            // Lobby
            if (lobbyList) {
                lobbyList.innerHTML = players.map(p => `
                    <div class="p-4 rounded-xl flex flex-col items-center gap-2 bg-white/10 border border-white/20 animate-in fade-in zoom-in duration-300">
                        <div class="relative">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold bg-gradient-to-br from-pink-500 to-purple-500 text-white shadow-lg">
                                ${p.name.charAt(0)}
                            </div>
                            <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span>
                        </div>
                        <span class="font-medium truncate w-full text-center text-white">${p.name}</span>
                        <span class="text-xs text-white/60">${p.score} Ù†Ù‚Ø·Ø©</span>
                    </div>
                `).join('');
                document.getElementById('lobby-count').innerText = `(${players.length})`;
            }

            // Game Sidebar
            if (gameList) {
                gameList.innerHTML = players.map(p => `
                    <div class="flex items-center gap-2 p-2 rounded-lg transition-all ${p.score === Math.max(...players.map(pl=>pl.score)) && p.score > 0 ? 'bg-yellow-500/20' : ''} ${p.id === roomData?.drawerId ? 'border border-pink-500' : ''}">
                        <div class="font-bold text-pink-500 w-6 text-center">${p.score}</div>
                        <div class="w-8 h-8 rounded-full flex items-center justify-center bg-white/10 text-xs font-bold shrink-0">
                            ${p.name.charAt(0)}
                        </div>
                        <div class="flex-1 truncate text-white text-sm">${p.name} ${p.id === roomData?.drawerId ? 'ğŸ–Œï¸' : ''}</div>
                    </div>
                `).join('');
            }
        }

        function renderMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = messages.map(msg => `
                <div class="p-2 rounded-lg text-sm mb-2 animate-in fade-in slide-in-from-right-2 ${msg.isSystem ? 'bg-green-500/20 text-green-400 font-bold text-center' : (msg.isDrawer ? 'bg-yellow-500/10 border border-yellow-500/30 text-yellow-200' : 'bg-white/10 text-white')}">
                    ${!msg.isSystem ? `<span class="font-bold opacity-70 block text-xs mb-1">${msg.sender}</span>` : ''}
                    <span class="break-words">${msg.text}</span>
                </div>
            `).join('');
            container.scrollTop = container.scrollHeight;
        }

        function updateGameUI() {
            const overlay = document.getElementById('game-overlay');
            const wordDisplay = document.getElementById('word-display');
            const toolbar = document.getElementById('drawing-tools');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');

            if (!roomData) return; // Guard clause

            if (roomData.status === 'finished') {
                overlay.classList.remove('hidden');
                document.getElementById('result-word').innerText = roomData.currentWord;
            } else {
                overlay.classList.add('hidden');
            }

            if (isDrawer) {
                wordDisplay.innerHTML = `<span class="text-green-400 bg-green-500/10 px-3 py-1 rounded-lg">${roomData.currentWord}</span>`;
                toolbar.classList.remove('hidden');
                chatInput.disabled = true;
                chatInput.placeholder = "Ø§Ù„Ø±Ø³Ø§Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ØªØ®Ù…ÙŠÙ†";
                sendBtn.disabled = true;
            } else {
                const hiddenWord = '_ '.repeat(roomData.currentWord.length);
                wordDisplay.innerHTML = `<span class="text-gray-400 tracking-[0.5em]">${hiddenWord}</span>`;
                toolbar.classList.add('hidden');
                chatInput.disabled = false;
                chatInput.placeholder = "Ø®Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø©...";
                sendBtn.disabled = false;
            }

            const drawer = players.find(p => p.id === roomData.drawerId);
            document.getElementById('drawer-name').innerText = drawer ? `${drawer.name}` : '...';
        }

        window.toggleTheme = () => {
            const body = document.body;
            body.classList.toggle('light-mode');
            const btn = document.getElementById('theme-btn');
            if (body.classList.contains('light-mode')) {
                btn.innerHTML = '<i data-lucide="moon"></i>';
            } else {
                btn.innerHTML = '<i data-lucide="sun"></i>';
            }
            lucide.createIcons();
        }

        window.onload = () => {
             lucide.createIcons();
             setInterval(() => {
                if (roomData?.status === 'playing' && timeLeft > 0) {
                     timeLeft--;
                     document.getElementById('timer-display').textContent = timeLeft + 's';
                }
             }, 1000);
        };

    </script>

    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: #ffffff;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        .light-mode {
            --bg-color: #eff6ff;
            --text-color: #1e293b;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden; 
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: inherit;
        }
        .glass-input:focus {
            border-color: #ec4899;
        }
        .light-mode .glass-input {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Ambient Background */
        .ambient-orb {
            position: absolute;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
            z-index: -1;
            animation: float 10s infinite ease-in-out;
        }
        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(20px, -20px); }
        }
        
        .c4man-link {
            text-decoration: none;
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- Ambient Background -->
    <div class="ambient-orb bg-purple-600 top-0 left-0"></div>
    <div class="ambient-orb bg-blue-600 bottom-0 right-0"></div>

    <!-- Header -->
    <header class="flex justify-between items-center p-4 z-20 shrink-0">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 glass-panel px-4 py-2 rounded-full">
                <i data-lucide="palette" class="text-pink-500"></i>
                <h1 class="text-xl font-bold bg-gradient-to-r from-pink-500 to-violet-500 bg-clip-text text-transparent hidden sm:block">Gartic Clone</h1>
                <span id="room-display" class="text-sm font-bold bg-white/10 px-2 py-1 rounded ml-2 hidden"></span>
            </div>
            
            <a href="https://instagram.com/c4man" target="_blank" class="glass-panel px-3 py-2 rounded-full hover:scale-105 transition flex items-center gap-2" title="Developer Instagram">
               <i data-lucide="instagram" class="w-5 h-5 text-pink-500"></i>
               <span class="c4man-link text-sm hidden sm:inline">c4man</span>
            </a>
        </div>

        <button id="theme-btn" onclick="toggleTheme()" class="p-2 rounded-full glass-panel hover:bg-white/10 transition">
            <i data-lucide="sun"></i>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative overflow-hidden container mx-auto px-4 h-full flex flex-col w-full pb-4">
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 flex items-center justify-center bg-slate-900 z-50">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500"></div>
        </div>

        <!-- Login View -->
        <div id="login-view" class="hidden h-full flex items-center justify-center">
            <div class="glass-panel p-8 rounded-3xl w-full max-w-md text-center">
                <div class="w-24 h-24 bg-gradient-to-tr from-pink-500 to-violet-500 rounded-full mx-auto mb-6 flex items-center justify-center shadow-lg shadow-pink-500/30">
                    <i data-lucide="user" class="w-12 h-12 text-white"></i>
                </div>
                <h2 class="text-3xl font-bold mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h2>
                <p class="mb-6 opacity-70">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© Ù„Ù„Ø¨Ø¯Ø¡</p>
                
                <div class="space-y-4">
                    <div class="relative">
                        <i data-lucide="user" class="absolute right-4 top-4 text-white/50 w-5 h-5"></i>
                        <input type="text" id="player-name" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±..." 
                            class="w-full p-4 pr-12 rounded-xl glass-input outline-none transition"
                            onkeydown="if(event.key === 'Enter') joinGame()">
                    </div>

                    <div class="relative">
                        <i data-lucide="key-round" class="absolute right-4 top-4 text-white/50 w-5 h-5"></i>
                        <input type="number" id="room-code" placeholder="Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ø§Ù„: 1010)" 
                            class="w-full p-4 pr-12 rounded-xl glass-input outline-none transition"
                            onkeydown="if(event.key === 'Enter') joinGame()">
                    </div>
                </div>
                
                <button onclick="joinGame()" class="w-full py-4 mt-6 bg-gradient-to-r from-pink-500 to-violet-600 rounded-xl font-bold text-white text-lg hover:opacity-90 transition shadow-lg shadow-pink-500/20">
                    Ø¯Ø®ÙˆÙ„ Ø§Ù„ØºØ±ÙØ©
                </button>
            </div>
        </div>

        <!-- Lobby View -->
        <div id="lobby-view" class="hidden h-full flex flex-col items-center justify-center">
            <div class="glass-panel w-full max-w-2xl rounded-3xl p-6 flex flex-col h-[70vh]">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                        Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† <span id="lobby-count" class="opacity-70 text-lg"></span>
                    </h2>
                    <button onclick="startGame()" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold transition flex items-center gap-2 shadow-lg shadow-green-500/20">
                        <i data-lucide="play" size="18"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©
                    </button>
                </div>
                <div id="lobby-players" class="flex-1 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-4 p-2">
                    <!-- Players injected here -->
                </div>
                <p class="text-center mt-4 opacity-50 text-sm">Ø§Ù†ØªØ¸Ø± Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</p>
            </div>
        </div>

        <!-- Game View -->
        <div id="game-view" class="hidden h-full flex flex-col md:flex-row gap-4">
            <!-- Sidebar -->
            <div id="players-sidebar" class="w-full md:w-56 flex flex-col gap-4 max-h-[120px] md:max-h-full transition-all duration-300 shrink-0">
                <div class="glass-panel p-4 rounded-2xl flex-1 overflow-hidden flex flex-col">
                    <h3 class="font-bold mb-3 border-b border-white/10 pb-2 text-sm uppercase tracking-wider opacity-70">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø§Ø·</h3>
                    <div id="game-players" class="overflow-y-auto space-y-2 pr-1 h-full custom-scrollbar">
                        <!-- Game players list -->
                    </div>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="flex-1 flex flex-col gap-4 h-full min-h-0">
                <!-- Top Info -->
                <div class="glass-panel p-3 rounded-xl flex items-center gap-4 shrink-0">
                    <div id="timer-display" class="text-xl font-bold text-pink-500 w-12 text-center bg-white/5 rounded p-1">0s</div>
                    <div id="word-display" class="text-2xl font-black text-center tracking-wider flex-1 truncate">...</div>
                    <div class="flex items-center gap-2">
                        <div id="drawer-name" class="text-sm opacity-70 w-24 text-left truncate hidden sm:block bg-white/5 px-2 py-1 rounded">...</div>
                        <button onclick="toggleMaximize()" class="p-2 hover:bg-white/10 rounded-lg transition" title="ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ±">
                            <i id="maximize-icon" data-lucide="maximize-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Canvas -->
                <div class="flex-1 glass-panel rounded-2xl relative overflow-hidden bg-white cursor-crosshair touch-none shadow-2xl">
                    <canvas id="drawing-canvas" class="absolute inset-0 w-full h-full block"></canvas>
                    
                    <!-- Result Overlay -->
                    <div id="game-overlay" class="hidden absolute inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center z-20">
                        <div class="bg-white text-slate-900 p-8 rounded-3xl text-center shadow-2xl animate-bounce max-w-sm mx-4">
                            <h2 class="text-2xl font-bold mb-2">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©!</h2>
                            <p class="text-lg opacity-70">Ø§Ù„ÙƒÙ„Ù…Ø© ÙƒØ§Ù†Øª:</p>
                            <p id="result-word" class="text-4xl font-black text-pink-600 mt-2">...</p>
                        </div>
                    </div>
                </div>

                <!-- Drawing Tools (Drawer Only) -->
                <div id="drawing-tools" class="glass-panel p-2 rounded-xl flex items-center gap-2 justify-center flex-wrap hidden shrink-0">
                    <div class="flex gap-1">
                        <button class="w-8 h-8 rounded-full border-2 border-white/20 hover:scale-110 transition bg-black" onclick="setTool('#000000', null)"></button>
                        <button class="w-8 h-8 rounded-full border-2 border-white/20 hover:scale-110 transition bg-red-500" onclick="setTool('#ef4444', null)"></button>
                        <button class="w-8 h-8 rounded-full border-2 border-white/20 hover:scale-110 transition bg-green-500" onclick="setTool('#22c55e', null)"></button>
                        <button class="w-8 h-8 rounded-full border-2 border-white/20 hover:scale-110 transition bg-blue-500" onclick="setTool('#3b82f6', null)"></button>
                        <button class="w-8 h-8 rounded-full border-2 border-white/20 hover:scale-110 transition bg-yellow-500" onclick="setTool('#eab308', null)"></button>
                    </div>
                    <div class="w-px h-6 bg-white/20 mx-2"></div>
                    <div class="flex items-center gap-2">
                        <button onclick="setTool(null, 2)" class="p-2 rounded hover:bg-white/10"><div class="w-1 h-1 bg-current rounded-full"></div></button>
                        <button onclick="setTool(null, 5)" class="p-2 rounded hover:bg-white/10"><div class="w-2 h-2 bg-current rounded-full"></div></button>
                        <button onclick="setTool(null, 10)" class="p-2 rounded hover:bg-white/10"><div class="w-3 h-3 bg-current rounded-full"></div></button>
                    </div>
                    <div class="w-px h-6 bg-white/20 mx-2"></div>
                    <button onclick="clearCanvas()" class="p-2 text-red-500 hover:bg-red-500/10 rounded-lg transition" title="Ù…Ø³Ø­">
                        <i data-lucide="trash-2"></i>
                    </button>
                    <button onclick="setTool('#ffffff', null)" class="p-2 hover:bg-white/10 rounded-lg transition" title="Ù…Ù…Ø­Ø§Ø©">
                        <i data-lucide="eraser"></i>
                    </button>
                </div>
            </div>

            <!-- Chat -->
            <div id="chat-sidebar" class="w-full md:w-64 glass-panel rounded-2xl flex flex-col h-48 md:h-full overflow-hidden shrink-0 transition-all duration-300">
                <div class="p-3 border-b border-white/10 font-bold text-sm flex items-center gap-2">
                    <i data-lucide="message-circle" class="w-4 h-4"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-3 flex flex-col gap-2 custom-scrollbar">
                    <!-- Messages injected here -->
                </div>
                <form onsubmit="sendMessage(event)" class="p-3 border-t border-white/10 flex gap-2 bg-black/20">
                    <input type="text" id="chat-input" placeholder="Ø®Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø©..." class="flex-1 glass-input rounded-lg px-3 py-2 text-sm outline-none placeholder-white/30">
                    <button type="submit" id="send-btn" class="p-2 bg-pink-500 rounded-lg text-white hover:opacity-90 shadow-lg shadow-pink-500/20">
                        <i data-lucide="send" size="16"></i>
                    </button>
                </form>
            </div>
        </div>
    </main>
</body>
</html>
